<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä»Šå¤©ä½ çµä¿®äº†å—ï¼Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            font-size: 14px;
            line-height: 1.5;
        }

        .container {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            min-height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 15px;
            text-align: center;
            position: relative;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            font-weight: 600;
        }

        .spirit-coins {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.25);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 1em;
            font-weight: bold;
            backdrop-filter: blur(10px);
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.5);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
            position: relative;
            font-weight: 500;
            backdrop-filter: blur(10px);
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: translateY(-1px);
        }

        .nav-btn:active {
            transform: translateY(0);
        }

        .nav-btn.has-notification::after {
            content: '';
            position: absolute;
            top: 6px;
            right: 6px;
            width: 8px;
            height: 8px;
            background: #e74c3c;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
            }
            70% {
                box-shadow: 0 0 0 8px rgba(231, 76, 60, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
            }
        }

        .main-content {
            padding: 15px;
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .calendar-section {
            margin-bottom: 20px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            position: relative;
            font-size: 0.9em;
            min-height: 40px;
        }

        .calendar-day:active {
            transform: scale(0.95);
        }

        .calendar-day:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .calendar-day.has-content {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: white;
            border-color: #4facfe;
        }

        .calendar-day.selected {
            border: 3px solid #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.4);
        }

        .devotion-section {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .devotion-section.active {
            display: flex;
        }

        .summary-section {
            display: none;
        }

        .summary-section.active {
            display: block;
        }

        .summary-container {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .summary-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #f0f0f0;
            transition: all 0.3s;
        }

        .summary-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f8f9fa;
        }

        .summary-date {
            font-size: 1.1em;
            font-weight: bold;
            color: #667eea;
        }

        .summary-coins {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .chat-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            -webkit-overflow-scrolling: touch;
            min-height: 300px;
        }

        .message {
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 12px;
            max-width: 85%;
            position: relative;
            transition: all 0.3s;
        }

        .message:active {
            transform: scale(0.98);
        }

        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .message.bot {
            background: white;
            border: 2px solid #f0f0f0;
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            gap: 8px;
        }

        .avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #f0f0f0;
            flex-shrink: 0;
        }

        .avatar.bot {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .message-info {
            flex: 1;
            min-width: 0;
        }

        .sender {
            font-weight: bold;
            margin-bottom: 2px;
            font-size: 0.9em;
        }

        .message.bot .sender {
            color: #667eea;
        }

        .message.user .sender {
            color: white;
        }

        .message-time {
            font-size: 0.75em;
            color: #999;
        }

        .message-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .action-btn {
            background: rgba(0, 0, 0, 0.1);
            border: none;
            color: #666;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin-left: 4px;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: rgba(0, 0, 0, 0.2);
            color: #333;
        }

        .action-btn.delete {
            color: #e74c3c;
        }

        .action-btn.regenerate {
            color: #3498db;
        }

        .message-type {
            font-size: 0.75em;
            padding: 2px 6px;
            border-radius: 8px;
            margin-bottom: 6px;
            display: inline-block;
            font-weight: bold;
        }

        .message-type.god {
            background: rgba(52, 152, 219, 0.15);
            color: #2980b9;
            border: 1px solid #3498db;
        }

        .message-type.self {
            background: rgba(230, 126, 34, 0.15);
            color: #d35400;
            border: 1px solid #e67e22;
        }

        .input-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 15px;
        }

        .input-box {
            background: white;
            border-radius: 12px;
            padding: 15px;
            border: 2px solid #f0f0f0;
        }

        .input-box h3 {
            margin-bottom: 8px;
            color: #333;
            font-size: 1em;
            font-weight: 600;
        }

        .input-box.god-focused h3 {
            color: #667eea;
        }

        .input-box.self-focused h3 {
            color: #e74c3c;
        }

        .input-box textarea {
            width: 100%;
            min-height: 80px;
            border: 2px solid #f0f0f0;
            border-radius: 8px;
            padding: 10px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
            line-height: 1.4;
        }

        .input-box textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            max-width: 150px;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            padding: 20px;
            box-sizing: border-box;
        }

        .settings-content {
            position: relative;
            background: white;
            border-radius: 15px;
            padding: 20px;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            top: 50%;
            transform: translateY(-50%);
        }

        .settings-group {
            margin-bottom: 15px;
        }

        .settings-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }

        .settings-group input,
        .settings-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #f0f0f0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .settings-group input:focus,
        .settings-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .close-modal:hover {
            background: #f0f0f0;
            color: #666;
        }

        .close-modal:active {
            transform: scale(0.9);
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .summary-table th,
        .summary-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .summary-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .summary-comment {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            border-left: 4px solid #667eea;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .coin-reward {
            color: #f39c12;
            font-weight: bold;
            font-size: 1em;
        }

        .coin-animation {
            position: fixed;
            font-size: 24px;
            animation: floatUp 2s ease-out forwards;
            pointer-events: none;
            z-index: 9999;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-80px);
            }
        }

        .weekend {
            background: #f8f9fa;
        }

        .model-info {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            margin-top: 5px;
            font-size: 0.85em;
            color: #666;
            line-height: 1.4;
        }

        .api-status {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.75em;
            margin-left: 8px;
        }

        .api-status.success {
            background: #d4edda;
            color: #155724;
        }

        .api-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .empty-summary {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-summary-icon {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-summary h3 {
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .empty-summary p {
            font-size: 0.9em;
            line-height: 1.4;
        }

        .generating-summary {
            text-align: center;
            padding: 15px;
            color: #667eea;
            font-style: italic;
            font-size: 0.9em;
        }

        /* è§¦æ‘¸ä¼˜åŒ– */
        @media (hover: none) {
            .message:hover .message-actions {
                opacity: 1;
            }
            
            .calendar-day:hover {
                transform: none;
            }
            
            .nav-btn:hover {
                transform: none;
            }
            
            .btn:hover {
                transform: none;
            }
        }

        /* å°å±å¹•ä¼˜åŒ– */
        @media (max-width: 360px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .nav-btn {
                padding: 6px 12px;
                font-size: 0.8em;
                min-height: 32px;
            }
            
            .spirit-coins {
                font-size: 0.9em;
                padding: 6px 10px;
            }
        }

        /* æ¨ªå±ä¼˜åŒ– */
        @media (orientation: landscape) and (max-height: 500px) {
            .header {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.4em;
                margin-bottom: 5px;
            }
            
            .nav-buttons {
                margin-top: 8px;
            }
            
            .main-content {
                padding: 10px;
            }
            
            .input-box textarea {
                min-height: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ä»Šå¤©ä½ çµä¿®äº†å—ï¼Ÿ</h1>
            <div class="spirit-coins">
                <span>ğŸª™ å±çµå¸: </span>
                <span id="coinCount">0</span>
            </div>
            <div class="nav-buttons">
                <button class="nav-btn" onclick="showCalendar()">æ—¥å†</button>
                <button class="nav-btn" onclick="showDevotion()">çµä¿®</button>
                <button class="nav-btn" id="summaryBtn" onclick="showSummary()">æ¯æ—¥æ€»ç»“</button>
                <button class="nav-btn" onclick="showSettings()">è®¾ç½®</button>
            </div>
        </header>

        <main class="main-content">
            <!-- æ—¥å†éƒ¨åˆ† -->
            <section id="calendarSection" class="calendar-section">
                <h2>é€‰æ‹©æ—¥æœŸæŸ¥çœ‹çµä¿®è®°å½•</h2>
                <div class="calendar-grid" id="calendarGrid"></div>
            </section>

            <!-- çµä¿®éƒ¨åˆ† -->
            <section id="devotionSection" class="devotion-section">
                <h2 id="selectedDate">ä»Šæ—¥çµä¿®</h2>
                
                <div class="chat-container" id="chatContainer">
                    <div class="message bot" data-message-id="welcome">
                        <div class="message-header">
                            <div class="avatar bot">å°è€¶</div>
                            <div class="message-info">
                                <div class="sender">å°è€¶æœºå™¨äºº</div>
                                <div class="message-time">åˆšåˆš</div>
                            </div>
                        </div>
                        <div>æ¬¢è¿æ¥åˆ°çµä¿®æ—¶é—´ï¼ä»Šå¤©ä½ æƒ³ä¸ä¸»åˆ†äº«ä»€ä¹ˆå‘¢ï¼Ÿ</div>
                    </div>
                </div>

                <div class="input-section">
                    <div class="input-box god-focused">
                        <h3>ğŸ™ ä»¥ç¥ä¸ºä¸­å¿ƒ</h3>
                        <textarea id="godInput" placeholder="ä»Šå¤©åˆç¡çš„æ—¶å€™æ€è€ƒä¸»çš„å¿ƒæ„æ˜¯ä»€ä¹ˆï¼Œæ˜ç™½äº†ä¸»æ˜¯è®©æˆ‘çš„è‡ªç”±..."></textarea>
                    </div>
                    <div class="input-box self-focused">
                        <h3>ğŸ§ ä»¥è‡ªæˆ‘ä¸ºä¸­å¿ƒ</h3>
                        <textarea id="selfInput" placeholder="è®°å½•è‡ªå·±çš„ç§æ¬²ã€æŒ£æ‰æˆ–éœ€è¦æ”¹è¿›çš„åœ°æ–¹..."></textarea>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="sendMessage()">å‘é€çµä¿®</button>
                    <button class="btn btn-success" id="generateSummaryBtn" onclick="generateSummary()">ç”Ÿæˆä»Šæ—¥æ€»ç»“</button>
                </div>
            </section>

            <!-- æ¯æ—¥æ€»ç»“éƒ¨åˆ† -->
            <section id="summarySection" class="summary-section">
                <h2>æ¯æ—¥æ€»ç»“</h2>
                <div class="summary-container" id="summaryContainer">
                    <div class="empty-summary">
                        <div class="empty-summary-icon">ğŸ“Š</div>
                        <h3>è¿˜æ²¡æœ‰æ€»ç»“è®°å½•</h3>
                        <p>å®Œæˆçµä¿®åç‚¹å‡»"ç”Ÿæˆä»Šæ—¥æ€»ç»“"æ¥æŸ¥çœ‹ä½ çš„å±çµæˆé•¿å†ç¨‹</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="settingsModal" class="settings-modal">
        <div class="settings-content">
            <span class="close-modal" onclick="closeSettings()">&times;</span>
            <h2>è®¾ç½®</h2>
            
            <div class="settings-group">
                <label>æ˜µç§°</label>
                <input type="text" id="nickname" placeholder="è¾“å…¥ä½ çš„æ˜µç§°">
            </div>

            <div class="settings-group">
                <label>å¤´åƒURL</label>
                <input type="text" id="avatarUrl" placeholder="è¾“å…¥å¤´åƒå›¾ç‰‡URL">
                <small style="color: #666; margin-top: 3px; display: block; font-size: 0.8em;">æ”¯æŒjpgã€pngã€gifç­‰æ ¼å¼ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤å¤´åƒ</small>
            </div>

            <div class="settings-group">
                <label>èƒŒæ™¯é¢œè‰²</label>
                <input type="color" id="bgColor" value="#667eea">
            </div>

            <div class="settings-group">
                <label>AIæ¨¡å‹é€‰æ‹©</label>
                <select id="aiModel" onchange="updateModelInfo()">
                    <option value="">è¯·é€‰æ‹©AIæ¨¡å‹</option>
                    <option value="openai">OpenAI GPT</option>
                    <option value="wenxin">æ–‡å¿ƒä¸€è¨€</option>
                    <option value="deepseek">DeepSeek</option>
                    <option value="qwen">é€šä¹‰åƒé—®</option>
                    <option value="moonshot">Moonshot (Kimi)</option>
                </select>
                <div id="modelInfo" class="model-info" style="display: none;"></div>
            </div>

            <div class="settings-group">
                <label>API Key</label>
                <input type="password" id="apiKey" placeholder="è¾“å…¥APIå¯†é’¥">
                <span id="apiStatus" class="api-status" style="display: none;"></span>
            </div>

            <div class="settings-group">
                <label>
                    <input type="checkbox" id="enableBot" checked> å¯ç”¨æœºå™¨äººè¯„è®º
                </label>
            </div>

            <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
            <button class="btn btn-success" onclick="testApiConnection()" style="margin-left: 10px;">æµ‹è¯•è¿æ¥</button>
        </div>
    </div>

    <script>
        // æ¨¡å‹é…ç½®
        const modelConfigs = {
            openai: {
                name: 'OpenAI GPT',
                apiUrl: 'https://api.openai.com/v1/chat/completions',
                model: 'gpt-3.5-turbo',
                info: 'æœ€å¼ºå¤§çš„é€šç”¨AIæ¨¡å‹ï¼Œæ”¯æŒå¤šç§è¯­è¨€ï¼Œé€‚åˆæ·±åº¦å¯¹è¯',
                keyHint: 'sk-...'
            },
            wenxin: {
                name: 'æ–‡å¿ƒä¸€è¨€',
                apiUrl: 'https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/completions',
                model: 'ernie-bot',
                info: 'ç™¾åº¦å‡ºå“ï¼Œä¸­æ–‡ç†è§£èƒ½åŠ›å¼ºï¼Œé€‚åˆå±çµæŒ‡å¯¼',
                keyHint: 'ç™¾åº¦API Key'
            },
            deepseek: {
                name: 'DeepSeek',
                apiUrl: 'https://api.deepseek.com/v1/chat/completions',
                model: 'deepseek-chat',
                info: 'æ€§ä»·æ¯”é«˜ï¼Œä»£ç å’Œæ¨ç†èƒ½åŠ›å¼ºï¼Œé€‚åˆæ·±åº¦æ€è€ƒ',
                keyHint: 'DeepSeek API Key'
            },
            qwen: {
                name: 'é€šä¹‰åƒé—®',
                apiUrl: 'https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation',
                model: 'qwen-turbo',
                info: 'é˜¿é‡Œäº‘å‡ºå“ï¼Œä¸­æ–‡ä¼˜ç§€ï¼Œé€‚åˆçµä¿®æŒ‡å¯¼',
                keyHint: 'é˜¿é‡Œäº‘DashScope Key'
            },
            moonshot: {
                name: 'Moonshot (Kimi)',
                apiUrl: 'https://api.moonshot.cn/v1/chat/completions',
                model: 'moonshot-v1-8k',
                info: 'é•¿æ–‡æœ¬å¤„ç†èƒ½åŠ›å¼ºï¼Œé€‚åˆæ·±åº¦å¯¹è¯',
                keyHint: 'Moonshot API Key'
            }
        };

        // æ•°æ®å­˜å‚¨
        let devotionData = JSON.parse(localStorage.getItem('devotionData')) || {};
        let summaryData = JSON.parse(localStorage.getItem('summaryData')) || {};
        let settings = JSON.parse(localStorage.getItem('settings')) || {
            nickname: 'å¼Ÿå…„/å§å¦¹',
            avatarUrl: '',
            bgColor: '#667eea',
            aiModel: '',
            apiKey: '',
            enableBot: true
        };
        let spiritCoins = parseInt(localStorage.getItem('spiritCoins')) || 0;
        let selectedDate = new Date().toISOString().split('T')[0];
        let messageIdCounter = 1;
        let hasNewSummary = false;

        // åˆå§‹åŒ–
        function init() {
            loadSettings();
            updateCoinDisplay();
            generateCalendar();
            showCalendar();
            checkNewSummary();
            loadSummaryData();
            
            // æ·»åŠ è§¦æ‘¸ä¼˜åŒ–
            addTouchOptimizations();
        }

        // æ·»åŠ è§¦æ‘¸ä¼˜åŒ–
        function addTouchOptimizations() {
            // é˜²æ­¢åŒå‡»ç¼©æ”¾
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);

            // ä¼˜åŒ–æ»šåŠ¨
            document.addEventListener('touchmove', function(e) {
                if (e.target.closest('.chat-container') || 
                    e.target.closest('.summary-container') || 
                    e.target.closest('.settings-content')) {
                    // å…è®¸å†…å®¹åŒºåŸŸæ»šåŠ¨
                    return;
                }
                // é˜²æ­¢é¡µé¢æ»šåŠ¨
                e.preventDefault();
            }, { passive: false });
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æ€»ç»“
        function checkNewSummary() {
            const today = new Date().toISOString().split('T')[0];
            const lastViewedSummary = localStorage.getItem('lastViewedSummary') || '';
            
            // æ£€æŸ¥ä»Šå¤©æ˜¯å¦æœ‰æ–°çš„æ€»ç»“
            if (summaryData[today] && summaryData[today].date > lastViewedSummary) {
                hasNewSummary = true;
                document.getElementById('summaryBtn').classList.add('has-notification');
            } else {
                hasNewSummary = false;
                document.getElementById('summaryBtn').classList.remove('has-notification');
            }
        }

        // åŠ è½½æ€»ç»“æ•°æ®
        function loadSummaryData() {
            const summaryContainer = document.getElementById('summaryContainer');
            const summaryDates = Object.keys(summaryData).sort((a, b) => new Date(b) - new Date(a));
            
            if (summaryDates.length === 0) {
                summaryContainer.innerHTML = `
                    <div class="empty-summary">
                        <div class="empty-summary-icon">ğŸ“Š</div>
                        <h3>è¿˜æ²¡æœ‰æ€»ç»“è®°å½•</h3>
                        <p>å®Œæˆçµä¿®åç‚¹å‡»"ç”Ÿæˆä»Šæ—¥æ€»ç»“"æ¥æŸ¥çœ‹ä½ çš„å±çµæˆé•¿å†ç¨‹</p>
                    </div>
                `;
                return;
            }
            
            summaryContainer.innerHTML = '';
            
            summaryDates.forEach(date => {
                const summary = summaryData[date];
                const summaryItem = document.createElement('div');
                summaryItem.className = 'summary-item';
                
                summaryItem.innerHTML = `
                    <div class="summary-header">
                        <div class="summary-date">${date}</div>
                        <div class="summary-coins">ğŸª™ ${summary.coins} æšå±çµå¸</div>
                    </div>
                    ${summary.html}
                `;
                
                summaryContainer.appendChild(summaryItem);
            });
        }

        // æ›´æ–°æ¨¡å‹ä¿¡æ¯
        function updateModelInfo() {
            const modelSelect = document.getElementById('aiModel');
            const modelInfo = document.getElementById('modelInfo');
            
            if (modelSelect.value && modelConfigs[modelSelect.value]) {
                const config = modelConfigs[modelSelect.value];
                modelInfo.innerHTML = `
                    <strong>${config.name}</strong><br>
                    ${config.info}<br>
                    <small>Keyæ ¼å¼: ${config.keyHint}</small>
                `;
                modelInfo.style.display = 'block';
            } else {
                modelInfo.style.display = 'none';
            }
        }

        // æµ‹è¯•APIè¿æ¥
        async function testApiConnection() {
            const model = document.getElementById('aiModel').value;
            const apiKey = document.getElementById('apiKey').value;
            const statusSpan = document.getElementById('apiStatus');
            
            if (!model || !apiKey) {
                statusSpan.textContent = 'è¯·é€‰æ‹©æ¨¡å‹å¹¶å¡«å†™API Key';
                statusSpan.className = 'api-status error';
                statusSpan.style.display = 'inline-block';
                return;
            }
            
            statusSpan.textContent = 'æµ‹è¯•ä¸­...';
            statusSpan.className = 'api-status';
            statusSpan.style.display = 'inline-block';
            
            try {
                const testPrompt = 'è¯·ç®€å•å›å¤ï¼šè¿æ¥æˆåŠŸ';
                const response = await callAI(testPrompt, '', model, apiKey);
                
                if (response) {
                    statusSpan.textContent = 'è¿æ¥æˆåŠŸ âœ“';
                    statusSpan.className = 'api-status success';
                } else {
                    throw new Error('æ— å“åº”');
                }
            } catch (error) {
                statusSpan.textContent = 'è¿æ¥å¤±è´¥ âœ—';
                statusSpan.className = 'api-status error';
                console.error('APIæµ‹è¯•å¤±è´¥:', error);
            }
        }

        // ç”Ÿæˆæ—¥å†
        function generateCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // è·å–æœˆä»½ç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            calendarGrid.innerHTML = '';
            
            // æ·»åŠ æ˜ŸæœŸæ ‡é¢˜
            const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            weekDays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.textContent = day;
                dayHeader.style.fontWeight = 'bold';
                dayHeader.style.textAlign = 'center';
                dayHeader.style.fontSize = '0.8em';
                dayHeader.style.color = '#666';
                calendarGrid.appendChild(dayHeader);
            });
            
            // ç”Ÿæˆæ—¥æœŸæ ¼å­
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                dayDiv.textContent = date.getDate();
                
                const dateStr = date.toISOString().split('T')[0];
                dayDiv.dataset.date = dateStr;
                
                // æ ‡è®°å‘¨æœ«
                if (date.getDay() === 0 || date.getDay() === 6) {
                    dayDiv.classList.add('weekend');
                }
                
                // æ ‡è®°æœ‰å†…å®¹çš„æ—¥æœŸ
                if (devotionData[dateStr] && devotionData[dateStr].messages) {
                    dayDiv.classList.add('has-content');
                }
                
                // æ ‡è®°ä»Šå¤©
                if (dateStr === selectedDate) {
                    dayDiv.classList.add('selected');
                }
                
                dayDiv.addEventListener('click', () => selectDate(dateStr));
                calendarGrid.appendChild(dayDiv);
            }
        }

        // é€‰æ‹©æ—¥æœŸ
        function selectDate(dateStr) {
            selectedDate = dateStr;
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('selected');
            });
            document.querySelector(`[data-date="${dateStr}"]`).classList.add('selected');
            
            showDevotion();
            loadDevotionContent(dateStr);
        }

        // åŠ è½½çµä¿®å†…å®¹
        function loadDevotionContent(dateStr) {
            const data = devotionData[dateStr];
            if (data && data.messages) {
                const chatContainer = document.getElementById('chatContainer');
                chatContainer.innerHTML = '';
                
                data.messages.forEach(msg => {
                    addMessageToChat(msg.sender, msg.content, msg.type, msg.timestamp, msg.messageId);
                });
            } else {
                const chatContainer = document.getElementById('chatContainer');
                chatContainer.innerHTML = `
                    <div class="message bot" data-message-id="welcome">
                        <div class="message-header">
                            <div class="avatar bot">å°è€¶</div>
                            <div class="message-info">
                                <div class="sender">å°è€¶æœºå™¨äºº</div>
                                <div class="message-time">åˆšåˆš</div>
                            </div>
                        </div>
                        <div>è¿™æ˜¯${dateStr}çš„çµä¿®è®°å½•ï¼Œè¿˜æ²¡æœ‰å†…å®¹ï¼Œå¼€å§‹è®°å½•å§ï¼</div>
                    </div>
                `;
            }
            
            document.getElementById('selectedDate').textContent = `${dateStr} çš„çµä¿®`;
        }

        // æ˜¾ç¤ºä¸åŒéƒ¨åˆ†
        function showCalendar() {
            document.getElementById('calendarSection').style.display = 'block';
            document.getElementById('devotionSection').classList.remove('active');
            document.getElementById('summarySection').classList.remove('active');
        }

        function showDevotion() {
            document.getElementById('calendarSection').style.display = 'none';
            document.getElementById('devotionSection').classList.add('active');
            document.getElementById('summarySection').classList.remove('active');
        }

        function showSummary() {
            document.getElementById('calendarSection').style.display = 'none';
            document.getElementById('devotionSection').classList.remove('active');
            document.getElementById('summarySection').classList.add('active');
            
            // æ ‡è®°å·²æŸ¥çœ‹
            if (hasNewSummary) {
                localStorage.setItem('lastViewedSummary', new Date().toISOString());
                document.getElementById('summaryBtn').classList.remove('has-notification');
                hasNewSummary = false;
            }
            
            loadSummaryData();
        }

        function showSettings() {
            document.getElementById('settingsModal').style.display = 'block';
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        // åˆ é™¤æ¶ˆæ¯
        function deleteMessage(messageId) {
            if (!devotionData[selectedDate] || !devotionData[selectedDate].messages) {
                return;
            }
            
            // ä»æ•°æ®ä¸­åˆ é™¤æ¶ˆæ¯
            devotionData[selectedDate].messages = devotionData[selectedDate].messages.filter(
                msg => msg.messageId !== messageId
            );
            
            // å¦‚æœæ²¡æœ‰æ¶ˆæ¯äº†ï¼Œåˆ é™¤æ•´ä¸ªæ—¥æœŸçš„æ•°æ®
            if (devotionData[selectedDate].messages.length === 0) {
                delete devotionData[selectedDate];
            }
            
            saveData();
            loadDevotionContent(selectedDate);
            generateCalendar();
            showNotification('æ¶ˆæ¯å·²åˆ é™¤');
        }

        // é‡æ–°ç”Ÿæˆè¯„è®º
        async function regenerateComment(messageId) {
            if (!settings.aiModel || !settings.apiKey) {
                showNotification('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®AIæ¨¡å‹å’ŒAPI Key');
                return;
            }
            
            // æ‰¾åˆ°å¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯
            const messageIndex = devotionData[selectedDate].messages.findIndex(
                msg => msg.messageId === messageId
            );
            
            if (messageIndex === -1) return;
            
            const userMessage = devotionData[selectedDate].messages[messageIndex];
            
            // è·å–å½“å¤©çš„æ‰€æœ‰ç”¨æˆ·æ¶ˆæ¯
            const userMessages = devotionData[selectedDate].messages.filter(m => m.type !== 'bot');
            const godMessages = userMessages.filter(m => m.type === 'god');
            const selfMessages = userMessages.filter(m => m.type === 'self');
            
            // ç”Ÿæˆæ–°çš„AIå›å¤
            const godContent = godMessages.map(m => m.content).join('\n');
            const selfContent = selfMessages.map(m => m.content).join('\n');
            
            try {
                const botResponse = await getAIResponse(godContent, selfContent);
                
                // åˆ é™¤æ—§çš„æœºå™¨äººè¯„è®º
                devotionData[selectedDate].messages = devotionData[selectedDate].messages.filter(
                    msg => !(msg.type === 'bot' && msg.sender === 'å°è€¶æœºå™¨äºº')
                );
                
                // æ·»åŠ æ–°çš„æœºå™¨äººè¯„è®º
                const newBotMessage = {
                    sender: 'å°è€¶æœºå™¨äºº',
                    content: botResponse,
                    type: 'bot',
                    timestamp: new Date().toISOString(),
                    messageId: 'bot_' + Date.now()
                };
                
                devotionData[selectedDate].messages.push(newBotMessage);
                
                saveData();
                loadDevotionContent(selectedDate);
                showNotification('è¯„è®ºå·²é‡æ–°ç”Ÿæˆ');
            } catch (error) {
                showNotification('é‡æ–°ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const godContent = document.getElementById('godInput').value.trim();
            const selfContent = document.getElementById('selfInput').value.trim();
            
            if (!godContent && !selfContent) {
                showNotification('è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªå†…å®¹æ¡†');
                return;
            }
            
            // åˆå§‹åŒ–æ—¥æœŸæ•°æ®
            if (!devotionData[selectedDate]) {
                devotionData[selectedDate] = { messages: [] };
            }
            
            const timestamp = new Date().toISOString();
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            if (godContent) {
                const messageId = 'god_' + Date.now();
                addMessageToChat(settings.nickname, godContent, 'god', timestamp, messageId);
                devotionData[selectedDate].messages.push({
                    sender: settings.nickname,
                    content: godContent,
                    type: 'god',
                    timestamp: timestamp,
                    messageId: messageId
                });
            }
            
            if (selfContent) {
                const messageId = 'self_' + Date.now();
                addMessageToChat(settings.nickname, selfContent, 'self', timestamp, messageId);
                devotionData[selectedDate].messages.push({
                    sender: settings.nickname,
                    content: selfContent,
                    type: 'self',
                    timestamp: timestamp,
                    messageId: messageId
                });
            }
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('godInput').value = '';
            document.getElementById('selfInput').value = '';
            
            // æœºå™¨äººè¯„è®º - å¿…é¡»ä½¿ç”¨AIæ¨¡å‹
            if (settings.enableBot && settings.aiModel && settings.apiKey) {
                setTimeout(async () => {
                    const botResponse = await getAIResponse(godContent, selfContent);
                    
                    const messageId = 'bot_' + Date.now();
                    addMessageToChat('å°è€¶æœºå™¨äºº', botResponse, 'bot', new Date().toISOString(), messageId);
                    devotionData[selectedDate].messages.push({
                        sender: 'å°è€¶æœºå™¨äºº',
                        content: botResponse,
                        type: 'bot',
                        timestamp: new Date().toISOString(),
                        messageId: messageId
                    });
                    saveData();
                }, 1000);
            } else if (settings.enableBot) {
                // å¦‚æœæ²¡æœ‰é…ç½®AIï¼Œæ˜¾ç¤ºæç¤º
                setTimeout(() => {
                    const errorMsg = 'è¯·åœ¨è®¾ç½®ä¸­é…ç½®AIæ¨¡å‹å’ŒAPI Keyä»¥è·å¾—æ™ºèƒ½å±çµæŒ‡å¯¼ã€‚';
                    const messageId = 'bot_error_' + Date.now();
                    addMessageToChat('å°è€¶æœºå™¨äºº', errorMsg, 'bot', new Date().toISOString(), messageId);
                    devotionData[selectedDate].messages.push({
                        sender: 'å°è€¶æœºå™¨äºº',
                        content: errorMsg,
                        type: 'bot',
                        timestamp: new Date().toISOString(),
                        messageId: messageId
                    });
                    saveData();
                }, 1000);
            }
            
            saveData();
            generateCalendar();
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©æ¡†
        function addMessageToChat(sender, content, type, timestamp = null, messageId = null) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type === 'bot' ? 'bot' : 'user'}`;
            messageDiv.dataset.messageId = messageId || 'msg_' + Date.now();
            
            // æ ¼å¼åŒ–æ—¶é—´
            const messageTime = timestamp ? new Date(timestamp).toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            }) : 'åˆšåˆš';
            
            // æ„å»ºå¤´åƒHTML
            let avatarHtml = '';
            if (type === 'bot') {
                avatarHtml = '<div class="avatar bot">å°è€¶</div>';
            } else {
                if (settings.avatarUrl) {
                    avatarHtml = `<img src="${settings.avatarUrl}" alt="å¤´åƒ" class="avatar" onerror="this.style.display='none'">`;
                } else {
                    // é»˜è®¤å¤´åƒä½¿ç”¨æ˜µç§°é¦–å­—
                    const initial = settings.nickname ? settings.nickname.charAt(0) : 'ç”¨';
                    avatarHtml = `<div class="avatar bot" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">${initial}</div>`;
                }
            }
            
            // æ„å»ºæ“ä½œæŒ‰é’®
            let actionsHtml = '';
            if (messageId && messageId !== 'welcome') {
                actionsHtml = `
                    <div class="message-actions">
                        ${type === 'bot' ? `<button class="action-btn regenerate" onclick="regenerateComment('${messageId}')">é‡æ–°ç”Ÿæˆ</button>` : ''}
                        <button class="action-btn delete" onclick="deleteMessage('${messageId}')">åˆ é™¤</button>
                    </div>
                `;
            }
            
            if (type === 'bot') {
                messageDiv.innerHTML = `
                    <div class="message-header">
                        ${avatarHtml}
                        <div class="message-info">
                            <div class="sender">${sender}</div>
                            <div class="message-time">${messageTime}</div>
                        </div>
                    </div>
                    <div>${content}</div>
                    ${actionsHtml}
                `;
            } else {
                let typeLabel = '';
                if (type === 'god') {
                    typeLabel = '<span class="message-type god">ğŸ™ ä»¥ç¥ä¸ºä¸­å¿ƒ</span>';
                } else if (type === 'self') {
                    typeLabel = '<span class="message-type self">ğŸ§ ä»¥è‡ªæˆ‘ä¸ºä¸­å¿ƒ</span>';
                }
                
                messageDiv.innerHTML = `
                    <div class="message-header">
                        ${avatarHtml}
                        <div class="message-info">
                            <div class="sender">${sender}</div>
                            <div class="message-time">${messageTime}</div>
                        </div>
                    </div>
                    ${typeLabel}
                    <div>${content}</div>
                    ${actionsHtml}
                `;
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // è°ƒç”¨AI API
        async function callAI(prompt, content, model, apiKey) {
            try {
                const config = modelConfigs[model];
                let requestBody, headers, apiUrl = config.apiUrl;
                
                // æ ¹æ®ä¸åŒæ¨¡å‹æ„å»ºè¯·æ±‚
                if (model === 'wenxin') {
                    // æ–‡å¿ƒä¸€è¨€æ ¼å¼
                    requestBody = {
                        messages: [
                            {
                                role: 'user',
                                content: prompt + '\n\n' + content
                            }
                        ]
                    };
                    headers = {
                        'Content-Type': 'application/json'
                    };
                    // æ–‡å¿ƒä¸€è¨€éœ€è¦å°†access_tokenæ”¾åœ¨URLä¸­
                    if (apiUrl.includes('?')) {
                        apiUrl += '&access_token=' + apiKey;
                    } else {
                        apiUrl += '?access_token=' + apiKey;
                    }
                } else if (model === 'qwen') {
                    // é€šä¹‰åƒé—®æ ¼å¼
                    requestBody = {
                        model: config.model,
                        input: {
                            messages: [
                                {
                                    role: 'system',
                                    content: 'ä½ æ˜¯ä¸€ä½æ¸©å’Œã€æ™ºæ…§çš„å±çµå¯¼å¸ˆï¼Œæ“…é•¿ç”¨åœ£ç»çœŸç†æŒ‡å¯¼ä¿¡å¾’çš„çµä¿®ç”Ÿæ´»ã€‚'
                                },
                                {
                                    role: 'user',
                                    content: prompt + '\n\n' + content
                                }
                            ]
                        },
                        parameters: {
                            max_tokens: 200,
                            temperature: 0.7
                        }
                    };
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    };
                } else {
                    // OpenAIå…¼å®¹æ ¼å¼ï¼ˆDeepSeek, Moonshot, OpenAIç­‰ï¼‰
                    requestBody = {
                        model: config.model,
                        messages: [
                            {
                                role: 'system',
                                content: 'ä½ æ˜¯ä¸€ä½æ¸©å’Œã€æ™ºæ…§çš„å±çµå¯¼å¸ˆï¼Œæ“…é•¿ç”¨åœ£ç»çœŸç†æŒ‡å¯¼ä¿¡å¾’çš„çµä¿®ç”Ÿæ´»ã€‚'
                            },
                            {
                                role: 'user',
                                content: prompt + '\n\n' + content
                            }
                        ],
                        max_tokens: 200,
                        temperature: 0.7
                    };
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    };
                }
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // æ ¹æ®ä¸åŒæ¨¡å‹è§£æå“åº”
                if (model === 'wenxin') {
                    return data.result || 'æ„Ÿè°¢ä½ çš„åˆ†äº«ï¼Œç»§ç»­åœ¨ä¸»é‡Œæˆé•¿ï¼';
                } else if (model === 'qwen') {
                    return data.output.text || 'æ„Ÿè°¢ä½ çš„åˆ†äº«ï¼Œç»§ç»­åœ¨ä¸»é‡Œæˆé•¿ï¼';
                } else {
                    return data.choices[0].message.content || 'æ„Ÿè°¢ä½ çš„åˆ†äº«ï¼Œç»§ç»­åœ¨ä¸»é‡Œæˆé•¿ï¼';
                }
            } catch (error) {
                console.error('AI APIè°ƒç”¨å¤±è´¥:', error);
                return null;
            }
        }

        // è·å–AIå›å¤
        async function getAIResponse(godContent, selfContent) {
            const prompt = `ä½œä¸ºä¸€ä½å±çµå¯¼å¸ˆï¼Œè¯·å¯¹ä»¥ä¸‹çµä¿®å†…å®¹ç»™äºˆæ¸©å’Œã€é¼“åŠ±æ€§çš„æŒ‡å¯¼ï¼ˆæ§åˆ¶åœ¨200å­—ä»¥å†…ï¼‰ï¼š
            
            ä»¥ç¥ä¸ºä¸­å¿ƒçš„å†…å®¹ï¼š${godContent || 'æ— '}
            ä»¥è‡ªæˆ‘ä¸ºä¸­å¿ƒçš„å†…å®¹ï¼š${selfContent || 'æ— '}
            
            è¯·ä»åŸºç£æ•™è§’åº¦ï¼Œæä¾›ç®€çŸ­è€Œæœ‰æ·±åº¦çš„å±çµæŒ‡å¯¼ï¼Œå¸®åŠ©ç”¨æˆ·æ›´å¥½åœ°ç†è§£ç¥çš„å¿ƒæ„å’Œè‡ªæˆ‘æˆé•¿ã€‚è¯·ç¡®ä¿å›å¤åœ¨200å­—ä»¥å†…ï¼Œè¯­è¨€ç®€æ´æœ‰åŠ›ã€‚`;
            
            const content = `ç”¨æˆ·åˆ†äº«äº†ä»Šå¤©çš„çµä¿®å†…å®¹ï¼Œè¯·ç»™äºˆå±çµæŒ‡å¯¼ã€‚`;
            return await callAI(prompt, content, settings.aiModel, settings.apiKey);
        }

        // ç”ŸæˆAIå†…å®¹æ¦‚è¦
        async function generateContentSummary(content, type) {
            const prompt = `è¯·ä¸ºä»¥ä¸‹${type}çµä¿®å†…å®¹ç”Ÿæˆä¸€ä¸ªç®€æ´çš„å†…å®¹æ¦‚è¦ï¼ˆ50å­—ä»¥å†…ï¼‰ï¼š
            
            å†…å®¹ï¼š${content || 'æ— '}
            
            è¯·ç”¨ä¸€å¥è¯æ¦‚æ‹¬ä¸»è¦å†…å®¹ï¼Œçªå‡ºé‡ç‚¹ï¼Œæ§åˆ¶åœ¨50å­—ä»¥å†…ã€‚`;
            
            return await callAI(prompt, '', settings.aiModel, settings.apiKey);
        }

        // ç”ŸæˆAIæ€»ç»“
        async function generateAISummary(godContent, selfContent, godCount, selfCount, totalCount) {
            const prompt = `ä½œä¸ºä¸€ä½å±çµå¯¼å¸ˆï¼Œè¯·ä¸ºç”¨æˆ·ä»Šå¤©çš„çµä¿®å†…å®¹ç”Ÿæˆä¸€ä¸ªæ¸©æš–è€Œæœ‰æ·±åº¦çš„æ€»ç»“ï¼ˆ200å­—ä»¥å†…ï¼‰ï¼š
            
            ä»¥ç¥ä¸ºä¸­å¿ƒçš„å†…å®¹æ•°é‡ï¼š${godCount}æ¡
            ä»¥è‡ªæˆ‘ä¸ºä¸­å¿ƒçš„å†…å®¹æ•°é‡ï¼š${selfCount}æ¡
            æ€»çµä¿®è®°å½•æ•°é‡ï¼š${totalCount}æ¡
            
            å…·ä½“å†…å®¹ï¼š
            ä»¥ç¥ä¸ºä¸­å¿ƒï¼š${godContent || 'æ— '}
            ä»¥è‡ªæˆ‘ä¸ºä¸­å¿ƒï¼š${selfContent || 'æ— '}
            
            è¯·ä»ä»¥ä¸‹è§’åº¦è¿›è¡Œåˆ†æå’ŒæŒ‡å¯¼ï¼š
            1. è¯„ä¼°ä»Šå¤©çµä¿®çš„å¹³è¡¡æ€§ï¼ˆç¥ä¸­å¿ƒvsè‡ªæˆ‘ä¸­å¿ƒï¼‰
            2. è¯†åˆ«å±çµæˆé•¿çš„äº®ç‚¹å’Œéœ€è¦æ”¹è¿›çš„åœ°æ–¹
            3. ç»™å‡ºå…·ä½“çš„ã€å¯æ“ä½œçš„å±çµå»ºè®®
            4. æä¾›åœ£ç»ä¸­çš„é¼“åŠ±å’Œå®‰æ…°
            
            è¯·ç”¨æ¸©æš–ã€é¼“åŠ±çš„è¯­è°ƒï¼Œè®©ç”¨æˆ·æ„Ÿå—åˆ°ç¥çš„åŒåœ¨å’Œçˆ±ã€‚è¯·ç¡®ä¿æ•´ä¸ªæ€»ç»“åœ¨200å­—ä»¥å†…ï¼Œè¯­è¨€ç²¾ç‚¼æœ‰åŠ›ã€‚`;
            
            return await callAI(prompt, '', settings.aiModel, settings.apiKey);
        }

        // ç”Ÿæˆæ€»ç»“
        async function generateSummary() {
            const data = devotionData[selectedDate];
            if (!data || !data.messages || data.messages.length === 0) {
                showNotification('è¯¥æ—¥æœŸè¿˜æ²¡æœ‰çµä¿®å†…å®¹');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦é…ç½®äº†AI
            if (!settings.aiModel || !settings.apiKey) {
                showNotification('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®AIæ¨¡å‹å’ŒAPI Keyä»¥ç”Ÿæˆæ™ºèƒ½æ€»ç»“');
                return;
            }
            
            // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            const generateBtn = document.getElementById('generateSummaryBtn');
            generateBtn.disabled = true;
            generateBtn.textContent = 'ç”Ÿæˆä¸­...';
            
            // è¿‡æ»¤æ‰æœºå™¨äººè¯„è®º
            const userMessages = data.messages.filter(m => m.type !== 'bot');
            const godMessages = userMessages.filter(m => m.type === 'god');
            const selfMessages = userMessages.filter(m => m.type === 'self');
            
            // è·å–æ‰€æœ‰å†…å®¹
            const godContent = godMessages.map(m => m.content).join('\n\n');
            const selfContent = selfMessages.map(m => m.content).join('\n\n');
            
            try {
                // ç”Ÿæˆå†…å®¹æ¦‚è¦
                const godSummary = godMessages.length > 0 ? 
                    await generateContentSummary(godContent, 'ä»¥ç¥ä¸ºä¸­å¿ƒ') : 'æš‚æ— è®°å½•';
                const selfSummary = selfMessages.length > 0 ? 
                    await generateContentSummary(selfContent, 'ä»¥è‡ªæˆ‘ä¸ºä¸­å¿ƒ') : 'æš‚æ— è®°å½•';
                
                // è°ƒç”¨AIç”Ÿæˆæ€»ç»“
                const aiSummary = await generateAISummary(
                    godContent, 
                    selfContent, 
                    godMessages.length, 
                    selfMessages.length, 
                    userMessages.length
                );
                
                // è®¡ç®—å¥–åŠ±
                const coinsEarned = Math.min(userMessages.length, 10);
                
                // ç”Ÿæˆæ€»ç»“HTML
                const summaryHtml = `
                    <table class="summary-table">
                        <tr>
                            <th>ç±»å‹</th>
                            <th>æ•°é‡</th>
                            <th>å†…å®¹æ¦‚è¦</th>
                        </tr>
                        <tr>
                            <td>ğŸ™ ä»¥ç¥ä¸ºä¸­å¿ƒ</td>
                            <td>${godMessages.length}</td>
                            <td>${godSummary}</td>
                        </tr>
                        <tr>
                            <td>ğŸ§ ä»¥è‡ªæˆ‘ä¸ºä¸­å¿ƒ</td>
                            <td>${selfMessages.length}</td>
                            <td>${selfSummary}</td>
                        </tr>
                        <tr>
                            <td>ğŸ’¬ æ€»æ¶ˆæ¯æ•°</td>
                            <td>${userMessages.length}</td>
                            <td>ä½ çš„çµä¿®è®°å½•</td>
                        </tr>
                    </table>
                    
                    <div class="summary-comment">
                        <strong>ğŸ“ AIæ™ºèƒ½æ€»ç»“ï¼š</strong><br>
                        ${aiSummary}<br><br>
                        <span class="coin-reward">ğŸª™ è·å¾— ${coinsEarned} æšå±çµå¸ï¼</span><br>
                        <small>ç»§ç»­åšæŒçµä¿®ï¼Œè®©å±çµç”Ÿå‘½ä¸æ–­æˆé•¿ï¼</small>
                    </div>
                `;
                
                // ä¿å­˜æ€»ç»“æ•°æ®
                summaryData[selectedDate] = {
                    html: summaryHtml,
                    coins: coinsEarned,
                    date: new Date().toISOString(),
                    godCount: godMessages.length,
                    selfCount: selfMessages.length,
                    totalCount: userMessages.length
                };
                
                localStorage.setItem('summaryData', JSON.stringify(summaryData));
                
                // æ›´æ–°å±çµå¸ï¼ˆåŸºäºæœ€åä¸€æ¬¡ç”Ÿæˆçš„è¡¨æ ¼ï¼‰
                // å…ˆå‡å»ä¹‹å‰å¯èƒ½ç»™è¿‡çš„å¸ï¼Œå†åŠ ä¸Šæ–°çš„
                if (summaryData[selectedDate] && summaryData[selectedDate].previousCoins) {
                    spiritCoins -= summaryData[selectedDate].previousCoins;
                }
                spiritCoins += coinsEarned;
                summaryData[selectedDate].previousCoins = coinsEarned;
                
                updateCoinDisplay();
                saveData();
                
                // æ˜¾ç¤ºè·å¾—å¸çš„åŠ¨ç”»
                showCoinAnimation(coinsEarned);
                
                // æ›´æ–°çº¢ç‚¹æç¤º
                checkNewSummary();
                
                showNotification(`AIæ€»ç»“ç”Ÿæˆå®Œæˆï¼è·å¾— ${coinsEarned} æšå±çµå¸ï¼å·²ä¿å­˜åˆ°æ¯æ—¥æ€»ç»“ç•Œé¢ã€‚`);
            } catch (error) {
                console.error('ç”ŸæˆAIæ€»ç»“å¤±è´¥:', error);
                showNotification('ç”ŸæˆAIæ€»ç»“å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                generateBtn.disabled = false;
                generateBtn.textContent = 'ç”Ÿæˆä»Šæ—¥æ€»ç»“';
            }
        }

        // æ˜¾ç¤ºè·å¾—å¸çš„åŠ¨ç”»
        function showCoinAnimation(coins) {
            for (let i = 0; i < coins; i++) {
                setTimeout(() => {
                    const coin = document.createElement('div');
                    coin.className = 'coin-animation';
                    coin.textContent = 'ğŸª™';
                    coin.style.left = Math.random() * window.innerWidth + 'px';
                    coin.style.top = window.innerHeight / 2 + 'px';
                    document.body.appendChild(coin);
                    
                    setTimeout(() => coin.remove(), 2000);
                }, i * 200);
            }
        }

        // æ›´æ–°å±çµå¸æ˜¾ç¤º
        function updateCoinDisplay() {
            document.getElementById('coinCount').textContent = spiritCoins;
        }

        // è®¾ç½®ç›¸å…³åŠŸèƒ½
        function loadSettings() {
            document.getElementById('nickname').value = settings.nickname;
            document.getElementById('avatarUrl').value = settings.avatarUrl;
            document.getElementById('bgColor').value = settings.bgColor;
            document.getElementById('aiModel').value = settings.aiModel || '';
            document.getElementById('apiKey').value = settings.apiKey;
            document.getElementById('enableBot').checked = settings.enableBot;
            
            // æ›´æ–°æ¨¡å‹ä¿¡æ¯
            updateModelInfo();
            
            // åº”ç”¨èƒŒæ™¯é¢œè‰²
            document.body.style.background = `linear-gradient(135deg, ${settings.bgColor} 0%, ${settings.bgColor}dd 100%)`;
        }

        function saveSettings() {
            settings.nickname = document.getElementById('nickname').value || 'å¼Ÿå…„/å§å¦¹';
            settings.avatarUrl = document.getElementById('avatarUrl').value;
            settings.bgColor = document.getElementById('bgColor').value;
            settings.aiModel = document.getElementById('aiModel').value;
            settings.apiKey = document.getElementById('apiKey').value;
            settings.enableBot = document.getElementById('enableBot').checked;
            
            localStorage.setItem('settings', JSON.stringify(settings));
            loadSettings();
            closeSettings();
            showNotification('è®¾ç½®å·²ä¿å­˜ï¼');
        }

        // ä¿å­˜æ•°æ®
        function saveData() {
            localStorage.setItem('devotionData', JSON.stringify(devotionData));
            localStorage.setItem('spiritCoins', spiritCoins.toString());
            localStorage.setItem('summaryData', JSON.stringify(summaryData));
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                left: 20px;
                background: #667eea;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
                font-size: 14px;
                text-align: center;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
