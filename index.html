<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»Šå¤©ä½ çµä¿®äº†å—ï¼Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .spirit-coins {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }

        .nav-btn:hover {
            background: white;
            color: #667eea;
            transform: translateY(-2px);
        }

        .main-content {
            padding: 30px;
        }

        .calendar-section {
            margin-bottom: 30px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 2px solid #ddd;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            position: relative;
        }

        .calendar-day:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .calendar-day.has-content {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: white;
            border-color: #4facfe;
        }

        .calendar-day.selected {
            border: 3px solid #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }

        .devotion-section {
            display: none;
        }

        .devotion-section.active {
            display: block;
        }

        .chat-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 15px;
            max-width: 80%;
            position: relative;
            transition: all 0.3s;
        }

        .message:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .message.bot {
            background: white;
            border: 2px solid #e9ecef;
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e9ecef;
        }

        .avatar.bot {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .message-info {
            flex: 1;
        }

        .sender {
            font-weight: bold;
            margin-bottom: 2px;
        }

        .message.bot .sender {
            color: #667eea;
        }

        .message.user .sender {
            color: white;
        }

        .message-time {
            font-size: 0.75em;
            color: #999;
        }

        .message-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .action-btn {
            background: rgba(0, 0, 0, 0.1);
            border: none;
            color: #666;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: rgba(0, 0, 0, 0.2);
            color: #333;
        }

        .action-btn.delete {
            color: #e74c3c;
        }

        .action-btn.regenerate {
            color: #3498db;
        }

        .message-type {
            font-size: 0.8em;
            padding: 2px 8px;
            border-radius: 10px;
            margin-bottom: 8px;
            display: inline-block;
            font-weight: bold;
        }

        .message-type.god {
            background: rgba(52, 152, 219, 0.2);
            color: #2980b9;
            border: 1px solid #3498db;
        }

        .message-type.self {
            background: rgba(230, 126, 34, 0.2);
            color: #d35400;
            border: 1px solid #e67e22;
        }

        .input-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-box {
            background: white;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #e9ecef;
        }

        .input-box h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .input-box.god-focused h3 {
            color: #667eea;
        }

        .input-box.self-focused h3 {
            color: #e74c3c;
        }

        .input-box textarea {
            width: 100%;
            min-height: 100px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 10px;
            font-size: 14px;
            resize: vertical;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .settings-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .settings-group {
            margin-bottom: 20px;
        }

        .settings-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .settings-group input,
        .settings-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 30px;
            cursor: pointer;
            color: #999;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .summary-table th,
        .summary-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        .summary-table th {
            background: #667eea;
            color: white;
        }

        .summary-comment {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
        }

        .coin-reward {
            color: #f39c12;
            font-weight: bold;
            font-size: 1.1em;
        }

        .coin-animation {
            position: fixed;
            font-size: 30px;
            animation: floatUp 2s ease-out forwards;
            pointer-events: none;
            z-index: 9999;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px);
            }
        }

        .weekend {
            background: #f8f9fa;
        }

        .model-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-top: 5px;
            font-size: 0.9em;
            color: #666;
        }

        .api-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .api-status.success {
            background: #d4edda;
            color: #155724;
        }

        .api-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .input-section {
                grid-template-columns: 1fr;
            }
            
            .calendar-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .header h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ä»Šå¤©ä½ çµä¿®äº†å—ï¼Ÿ</h1>
            <div class="spirit-coins">
                <span>ğŸª™ å±çµå¸: </span>
                <span id="coinCount">0</span>
            </div>
            <div class="nav-buttons">
                <button class="nav-btn" onclick="showCalendar()">æ—¥å†</button>
                <button class="nav-btn" onclick="showDevotion()">çµä¿®</button>
                <button class="nav-btn" onclick="showSettings()">è®¾ç½®</button>
            </div>
        </header>

        <main class="main-content">
            <!-- æ—¥å†éƒ¨åˆ† -->
            <section id="calendarSection" class="calendar-section">
                <h2>é€‰æ‹©æ—¥æœŸæŸ¥çœ‹çµä¿®è®°å½•</h2>
                <div class="calendar-grid" id="calendarGrid"></div>
            </section>

            <!-- çµä¿®éƒ¨åˆ† -->
            <section id="devotionSection" class="devotion-section">
                <h2 id="selectedDate">ä»Šæ—¥çµä¿®</h2>
                
                <div class="chat-container" id="chatContainer">
                    <div class="message bot" data-message-id="welcome">
                        <div class="message-header">
                            <div class="avatar bot">å°è€¶</div>
                            <div class="message-info">
                                <div class="sender">å°è€¶æœºå™¨äºº</div>
                                <div class="message-time">åˆšåˆš</div>
                            </div>
                        </div>
                        <div>æ¬¢è¿æ¥åˆ°çµä¿®æ—¶é—´ï¼ä»Šå¤©ä½ æƒ³ä¸ä¸»åˆ†äº«ä»€ä¹ˆå‘¢ï¼Ÿ</div>
                    </div>
                </div>

                <div class="input-section">
                    <div class="input-box god-focused">
                        <h3>ğŸ™ ä»¥ç¥ä¸ºä¸­å¿ƒ</h3>
                        <textarea id="godInput" placeholder="ä»Šå¤©åˆç¡çš„æ—¶å€™æ€è€ƒä¸»çš„å¿ƒæ„æ˜¯ä»€ä¹ˆï¼Œæ˜ç™½äº†ä¸»æ˜¯è®©æˆ‘çš„è‡ªç”±..."></textarea>
                    </div>
                    <div class="input-box self-focused">
                        <h3>ğŸ§ ä»¥è‡ªæˆ‘ä¸ºä¸­å¿ƒ</h3>
                        <textarea id="selfInput" placeholder="è®°å½•è‡ªå·±çš„ç§æ¬²ã€æŒ£æ‰æˆ–éœ€è¦æ”¹è¿›çš„åœ°æ–¹..."></textarea>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="sendMessage()">å‘é€çµä¿®</button>
                    <button class="btn btn-success" onclick="generateSummary()">ç”Ÿæˆä»Šæ—¥æ€»ç»“</button>
                </div>
            </section>
        </main>
    </div>

    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="settingsModal" class="settings-modal">
        <div class="settings-content">
            <span class="close-modal" onclick="closeSettings()">&times;</span>
            <h2>è®¾ç½®</h2>
            
            <div class="settings-group">
                <label>æ˜µç§°</label>
                <input type="text" id="nickname" placeholder="è¾“å…¥ä½ çš„æ˜µç§°">
            </div>

            <div class="settings-group">
                <label>å¤´åƒURL</label>
                <input type="text" id="avatarUrl" placeholder="è¾“å…¥å¤´åƒå›¾ç‰‡URL">
                <small style="color: #666; margin-top: 5px; display: block;">æ”¯æŒjpgã€pngã€gifç­‰æ ¼å¼ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤å¤´åƒ</small>
            </div>

            <div class="settings-group">
                <label>èƒŒæ™¯é¢œè‰²</label>
                <input type="color" id="bgColor" value="#667eea">
            </div>

            <div class="settings-group">
                <label>AIæ¨¡å‹é€‰æ‹©</label>
                <select id="aiModel" onchange="updateModelInfo()">
                    <option value="">è¯·é€‰æ‹©AIæ¨¡å‹</option>
                    <option value="openai">OpenAI GPT</option>
                    <option value="wenxin">æ–‡å¿ƒä¸€è¨€</option>
                    <option value="deepseek">DeepSeek</option>
                    <option value="qwen">é€šä¹‰åƒé—®</option>
                    <option value="moonshot">Moonshot (Kimi)</option>
                </select>
                <div id="modelInfo" class="model-info" style="display: none;"></div>
            </div>

            <div class="settings-group">
                <label>API Key</label>
                <input type="password" id="apiKey" placeholder="è¾“å…¥APIå¯†é’¥">
                <span id="apiStatus" class="api-status" style="display: none;"></span>
            </div>

            <div class="settings-group">
                <label>
                    <input type="checkbox" id="enableBot" checked> å¯ç”¨æœºå™¨äººè¯„è®º
                </label>
            </div>

            <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
            <button class="btn btn-success" onclick="testApiConnection()" style="margin-left: 10px;">æµ‹è¯•è¿æ¥</button>
        </div>
    </div>

    <script>
        // æ¨¡å‹é…ç½®
        const modelConfigs = {
            openai: {
                name: 'OpenAI GPT',
                apiUrl: 'https://api.openai.com/v1/chat/completions',
                model: 'gpt-3.5-turbo',
                info: 'æœ€å¼ºå¤§çš„é€šç”¨AIæ¨¡å‹ï¼Œæ”¯æŒå¤šç§è¯­è¨€ï¼Œé€‚åˆæ·±åº¦å¯¹è¯',
                keyHint: 'sk-...'
            },
            wenxin: {
                name: 'æ–‡å¿ƒä¸€è¨€',
                apiUrl: 'https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/completions',
                model: 'ernie-bot',
                info: 'ç™¾åº¦å‡ºå“ï¼Œä¸­æ–‡ç†è§£èƒ½åŠ›å¼ºï¼Œé€‚åˆå±çµæŒ‡å¯¼',
                keyHint: 'ç™¾åº¦API Key'
            },
            deepseek: {
                name: 'DeepSeek',
                apiUrl: 'https://api.deepseek.com/v1/chat/completions',
                model: 'deepseek-chat',
                info: 'æ€§ä»·æ¯”é«˜ï¼Œä»£ç å’Œæ¨ç†èƒ½åŠ›å¼ºï¼Œé€‚åˆæ·±åº¦æ€è€ƒ',
                keyHint: 'DeepSeek API Key'
            },
            qwen: {
                name: 'é€šä¹‰åƒé—®',
                apiUrl: 'https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation',
                model: 'qwen-turbo',
                info: 'é˜¿é‡Œäº‘å‡ºå“ï¼Œä¸­æ–‡ä¼˜ç§€ï¼Œé€‚åˆçµä¿®æŒ‡å¯¼',
                keyHint: 'é˜¿é‡Œäº‘DashScope Key'
            },
            moonshot: {
                name: 'Moonshot (Kimi)',
                apiUrl: 'https://api.moonshot.cn/v1/chat/completions',
                model: 'moonshot-v1-8k',
                info: 'é•¿æ–‡æœ¬å¤„ç†èƒ½åŠ›å¼ºï¼Œé€‚åˆæ·±åº¦å¯¹è¯',
                keyHint: 'Moonshot API Key'
            }
        };

        // æ•°æ®å­˜å‚¨
        let devotionData = JSON.parse(localStorage.getItem('devotionData')) || {};
        let settings = JSON.parse(localStorage.getItem('settings')) || {
            nickname: 'å¼Ÿå…„/å§å¦¹',
            avatarUrl: '',
            bgColor: '#667eea',
            aiModel: '',
            apiKey: '',
            enableBot: true
        };
        let spiritCoins = parseInt(localStorage.getItem('spiritCoins')) || 0;
        let selectedDate = new Date().toISOString().split('T')[0];
        let messageIdCounter = 1;

        // åˆå§‹åŒ–
        function init() {
            loadSettings();
            updateCoinDisplay();
            generateCalendar();
            showCalendar();
        }

        // æ›´æ–°æ¨¡å‹ä¿¡æ¯
        function updateModelInfo() {
            const modelSelect = document.getElementById('aiModel');
            const modelInfo = document.getElementById('modelInfo');
            
            if (modelSelect.value && modelConfigs[modelSelect.value]) {
                const config = modelConfigs[modelSelect.value];
                modelInfo.innerHTML = `
                    <strong>${config.name}</strong><br>
                    ${config.info}<br>
                    <small>Keyæ ¼å¼: ${config.keyHint}</small>
                `;
                modelInfo.style.display = 'block';
            } else {
                modelInfo.style.display = 'none';
            }
        }

        // æµ‹è¯•APIè¿æ¥
        async function testApiConnection() {
            const model = document.getElementById('aiModel').value;
            const apiKey = document.getElementById('apiKey').value;
            const statusSpan = document.getElementById('apiStatus');
            
            if (!model || !apiKey) {
                statusSpan.textContent = 'è¯·é€‰æ‹©æ¨¡å‹å¹¶å¡«å†™API Key';
                statusSpan.className = 'api-status error';
                statusSpan.style.display = 'inline-block';
                return;
            }
            
            statusSpan.textContent = 'æµ‹è¯•ä¸­...';
            statusSpan.className = 'api-status';
            statusSpan.style.display = 'inline-block';
            
            try {
                const testPrompt = 'è¯·ç®€å•å›å¤ï¼šè¿æ¥æˆåŠŸ';
                const response = await callAI(testPrompt, '', model, apiKey);
                
                if (response) {
                    statusSpan.textContent = 'è¿æ¥æˆåŠŸ âœ“';
                    statusSpan.className = 'api-status success';
                } else {
                    throw new Error('æ— å“åº”');
                }
            } catch (error) {
                statusSpan.textContent = 'è¿æ¥å¤±è´¥ âœ—';
                statusSpan.className = 'api-status error';
                console.error('APIæµ‹è¯•å¤±è´¥:', error);
            }
        }

        // ç”Ÿæˆæ—¥å†
        function generateCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // è·å–æœˆä»½ç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            calendarGrid.innerHTML = '';
            
            // æ·»åŠ æ˜ŸæœŸæ ‡é¢˜
            const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            weekDays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.textContent = day;
                dayHeader.style.fontWeight = 'bold';
                dayHeader.style.textAlign = 'center';
                calendarGrid.appendChild(dayHeader);
            });
            
            // ç”Ÿæˆæ—¥æœŸæ ¼å­
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                dayDiv.textContent = date.getDate();
                
                const dateStr = date.toISOString().split('T')[0];
                dayDiv.dataset.date = dateStr;
                
                // æ ‡è®°å‘¨æœ«
                if (date.getDay() === 0 || date.getDay() === 6) {
                    dayDiv.classList.add('weekend');
                }
                
                // æ ‡è®°æœ‰å†…å®¹çš„æ—¥æœŸ
                if (devotionData[dateStr] && devotionData[dateStr].messages) {
                    dayDiv.classList.add('has-content');
                }
                
                // æ ‡è®°ä»Šå¤©
                if (dateStr === selectedDate) {
                    dayDiv.classList.add('selected');
                }
                
                dayDiv.addEventListener('click', () => selectDate(dateStr));
                calendarGrid.appendChild(dayDiv);
            }
        }

        // é€‰æ‹©æ—¥æœŸ
        function selectDate(dateStr) {
            selectedDate = dateStr;
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('selected');
            });
            document.querySelector(`[data-date="${dateStr}"]`).classList.add('selected');
            
            showDevotion();
            loadDevotionContent(dateStr);
        }

        // åŠ è½½çµä¿®å†…å®¹
        function loadDevotionContent(dateStr) {
            const data = devotionData[dateStr];
            if (data && data.messages) {
                const chatContainer = document.getElementById('chatContainer');
                chatContainer.innerHTML = '';
                
                data.messages.forEach(msg => {
                    addMessageToChat(msg.sender, msg.content, msg.type, msg.timestamp, msg.messageId);
                });
            } else {
                const chatContainer = document.getElementById('chatContainer');
                chatContainer.innerHTML = `
                    <div class="message bot" data-message-id="welcome">
                        <div class="message-header">
                            <div class="avatar bot">å°è€¶</div>
                            <div class="message-info">
                                <div class="sender">å°è€¶æœºå™¨äºº</div>
                                <div class="message-time">åˆšåˆš</div>
                            </div>
                        </div>
                        <div>è¿™æ˜¯${dateStr}çš„çµä¿®è®°å½•ï¼Œè¿˜æ²¡æœ‰å†…å®¹ï¼Œå¼€å§‹è®°å½•å§ï¼</div>
                    </div>
                `;
            }
            
            document.getElementById('selectedDate').textContent = `${dateStr} çš„çµä¿®`;
        }

        // æ˜¾ç¤ºä¸åŒéƒ¨åˆ†
        function showCalendar() {
            document.getElementById('calendarSection').style.display = 'block';
            document.getElementById('devotionSection').classList.remove('active');
        }

        function showDevotion() {
            document.getElementById('calendarSection').style.display = 'none';
            document.getElementById('devotionSection').classList.add('active');
        }

        function showSettings() {
            document.getElementById('settingsModal').style.display = 'block';
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        // åˆ é™¤æ¶ˆæ¯
        function deleteMessage(messageId) {
            if (!devotionData[selectedDate] || !devotionData[selectedDate].messages) {
                return;
            }
            
            // ä»æ•°æ®ä¸­åˆ é™¤æ¶ˆæ¯
            devotionData[selectedDate].messages = devotionData[selectedDate].messages.filter(
                msg => msg.messageId !== messageId
            );
            
            // å¦‚æœæ²¡æœ‰æ¶ˆæ¯äº†ï¼Œåˆ é™¤æ•´ä¸ªæ—¥æœŸçš„æ•°æ®
            if (devotionData[selectedDate].messages.length === 0) {
                delete devotionData[selectedDate];
            }
            
            saveData();
            loadDevotionContent(selectedDate);
            generateCalendar();
            showNotification('æ¶ˆæ¯å·²åˆ é™¤');
        }

        // é‡æ–°ç”Ÿæˆè¯„è®º
        async function regenerateComment(messageId) {
            if (!settings.aiModel || !settings.apiKey) {
                showNotification('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®AIæ¨¡å‹å’ŒAPI Key');
                return;
            }
            
            // æ‰¾åˆ°å¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯
            const messageIndex = devotionData[selectedDate].messages.findIndex(
                msg => msg.messageId === messageId
            );
            
            if (messageIndex === -1) return;
            
            const userMessage = devotionData[selectedDate].messages[messageIndex];
            
            // è·å–å½“å¤©çš„æ‰€æœ‰ç”¨æˆ·æ¶ˆæ¯
            const userMessages = devotionData[selectedDate].messages.filter(m => m.type !== 'bot');
            const godMessages = userMessages.filter(m => m.type === 'god');
            const selfMessages = userMessages.filter(m => m.type === 'self');
            
            // ç”Ÿæˆæ–°çš„AIå›å¤
            const godContent = godMessages.map(m => m.content).join('\n');
            const selfContent = selfMessages.map(m => m.content).join('\n');
            
            try {
                const botResponse = await getAIResponse(godContent, selfContent);
                
                // åˆ é™¤æ—§çš„æœºå™¨äººè¯„è®º
                devotionData[selectedDate].messages = devotionData[selectedDate].messages.filter(
                    msg => !(msg.type === 'bot' && msg.sender === 'å°è€¶æœºå™¨äºº')
                );
                
                // æ·»åŠ æ–°çš„æœºå™¨äººè¯„è®º
                const newBotMessage = {
                    sender: 'å°è€¶æœºå™¨äºº',
                    content: botResponse,
                    type: 'bot',
                    timestamp: new Date().toISOString(),
                    messageId: 'bot_' + Date.now()
                };
                
                devotionData[selectedDate].messages.push(newBotMessage);
                
                saveData();
                loadDevotionContent(selectedDate);
                showNotification('è¯„è®ºå·²é‡æ–°ç”Ÿæˆ');
            } catch (error) {
                showNotification('é‡æ–°ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const godContent = document.getElementById('godInput').value.trim();
            const selfContent = document.getElementById('selfInput').value.trim();
            
            if (!godContent && !selfContent) {
                showNotification('è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªå†…å®¹æ¡†');
                return;
            }
            
            // åˆå§‹åŒ–æ—¥æœŸæ•°æ®
            if (!devotionData[selectedDate]) {
                devotionData[selectedDate] = { messages: [] };
            }
            
            const timestamp = new Date().toISOString();
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            if (godContent) {
                const messageId = 'god_' + Date.now();
                addMessageToChat(settings.nickname, godContent, 'god', timestamp, messageId);
                devotionData[selectedDate].messages.push({
                    sender: settings.nickname,
                    content: godContent,
                    type: 'god',
                    timestamp: timestamp,
                    messageId: messageId
                });
            }
            
            if (selfContent) {
                const messageId = 'self_' + Date.now();
                addMessageToChat(settings.nickname, selfContent, 'self', timestamp, messageId);
                devotionData[selectedDate].messages.push({
                    sender: settings.nickname,
                    content: selfContent,
                    type: 'self',
                    timestamp: timestamp,
                    messageId: messageId
                });
            }
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('godInput').value = '';
            document.getElementById('selfInput').value = '';
            
            // æœºå™¨äººè¯„è®º - å¿…é¡»ä½¿ç”¨AIæ¨¡å‹
            if (settings.enableBot && settings.aiModel && settings.apiKey) {
                setTimeout(async () => {
                    const botResponse = await getAIResponse(godContent, selfContent);
                    
                    const messageId = 'bot_' + Date.now();
                    addMessageToChat('å°è€¶æœºå™¨äºº', botResponse, 'bot', new Date().toISOString(), messageId);
                    devotionData[selectedDate].messages.push({
                        sender: 'å°è€¶æœºå™¨äºº',
                        content: botResponse,
                        type: 'bot',
                        timestamp: new Date().toISOString(),
                        messageId: messageId
                    });
                    saveData();
                }, 1000);
            } else if (settings.enableBot) {
                // å¦‚æœæ²¡æœ‰é…ç½®AIï¼Œæ˜¾ç¤ºæç¤º
                setTimeout(() => {
                    const errorMsg = 'è¯·åœ¨è®¾ç½®ä¸­é…ç½®AIæ¨¡å‹å’ŒAPI Keyä»¥è·å¾—æ™ºèƒ½å±çµæŒ‡å¯¼ã€‚';
                    const messageId = 'bot_error_' + Date.now();
                    addMessageToChat('å°è€¶æœºå™¨äºº', errorMsg, 'bot', new Date().toISOString(), messageId);
                    devotionData[selectedDate].messages.push({
                        sender: 'å°è€¶æœºå™¨äºº',
                        content: errorMsg,
                        type: 'bot',
                        timestamp: new Date().toISOString(),
                        messageId: messageId
                    });
                    saveData();
                }, 1000);
            }
            
            saveData();
            generateCalendar();
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©æ¡†
        function addMessageToChat(sender, content, type, timestamp = null, messageId = null) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type === 'bot' ? 'bot' : 'user'}`;
            messageDiv.dataset.messageId = messageId || 'msg_' + Date.now();
            
            // æ ¼å¼åŒ–æ—¶é—´
            const messageTime = timestamp ? new Date(timestamp).toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            }) : 'åˆšåˆš';
            
            // æ„å»ºå¤´åƒHTML
            let avatarHtml = '';
            if (type === 'bot') {
                avatarHtml = '<div class="avatar bot">å°è€¶</div>';
            } else {
                if (settings.avatarUrl) {
                    avatarHtml = `<img src="${settings.avatarUrl}" alt="å¤´åƒ" class="avatar" onerror="this.style.display='none'">`;
                } else {
                    // é»˜è®¤å¤´åƒä½¿ç”¨æ˜µç§°é¦–å­—
                    const initial = settings.nickname ? settings.nickname.charAt(0) : 'ç”¨';
                    avatarHtml = `<div class="avatar bot" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">${initial}</div>`;
                }
            }
            
            // æ„å»ºæ“ä½œæŒ‰é’®
            let actionsHtml = '';
            if (messageId && messageId !== 'welcome') {
                actionsHtml = `
                    <div class="message-actions">
                        ${type === 'bot' ? `<button class="action-btn regenerate" onclick="regenerateComment('${messageId}')">é‡æ–°ç”Ÿæˆ</button>` : ''}
                        <button class="action-btn delete" onclick="deleteMessage('${messageId}')">åˆ é™¤</button>
                    </div>
                `;
            }
            
            if (type === 'bot') {
                messageDiv.innerHTML = `
                    <div class="message-header">
                        ${avatarHtml}
                        <div class="message-info">
                            <div class="sender">${sender}</div>
                            <div class="message-time">${messageTime}</div>
                        </div>
                    </div>
                    <div>${content}</div>
                    ${actionsHtml}
                `;
            } else {
                let typeLabel = '';
                if (type === 'god') {
                    typeLabel = '<span class="message-type god">ğŸ™ ä»¥ç¥ä¸ºä¸­å¿ƒ</span>';
                } else if (type === 'self') {
                    typeLabel = '<span class="message-type self">ğŸ§ ä»¥è‡ªæˆ‘ä¸ºä¸­å¿ƒ</span>';
                }
                
                messageDiv.innerHTML = `
                    <div class="message-header">
                        ${avatarHtml}
                        <div class="message-info">
                            <div class="sender">${sender}</div>
                            <div class="message-time">${messageTime}</div>
                        </div>
                    </div>
                    ${typeLabel}
                    <div>${content}</div>
                    ${actionsHtml}
                `;
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // è°ƒç”¨AI API
        async function callAI(prompt, content, model, apiKey) {
            try {
                const config = modelConfigs[model];
                let requestBody, headers, apiUrl = config.apiUrl;
                
                // æ ¹æ®ä¸åŒæ¨¡å‹æ„å»ºè¯·æ±‚
                if (model === 'wenxin') {
                    // æ–‡å¿ƒä¸€è¨€æ ¼å¼
                    requestBody = {
                        messages: [
                            {
                                role: 'user',
                                content: prompt + '\n\n' + content
                            }
                        ]
                    };
                    headers = {
                        'Content-Type': 'application/json'
                    };
                    // æ–‡å¿ƒä¸€è¨€éœ€è¦å°†access_tokenæ”¾åœ¨URLä¸­
                    if (apiUrl.includes('?')) {
                        apiUrl += '&access_token=' + apiKey;
                    } else {
                        apiUrl += '?access_token=' + apiKey;
                    }
                } else if (model === 'qwen') {
                    // é€šä¹‰åƒé—®æ ¼å¼
                    requestBody = {
                        model: config.model,
                        input: {
                            messages: [
                                {
                                    role: 'system',
                                    content: 'ä½ æ˜¯ä¸€ä½æ¸©å’Œã€æ™ºæ…§çš„å±çµå¯¼å¸ˆï¼Œæ“…é•¿ç”¨åœ£ç»çœŸç†æŒ‡å¯¼ä¿¡å¾’çš„çµä¿®ç”Ÿæ´»ã€‚'
                                },
                                {
                                    role: 'user',
                                    content: prompt + '\n\n' + content
                                }
                            ]
                        },
                        parameters: {
                            max_tokens: 200,
                            temperature: 0.7
                        }
                    };
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    };
                } else {
                    // OpenAIå…¼å®¹æ ¼å¼ï¼ˆDeepSeek, Moonshot, OpenAIç­‰ï¼‰
                    requestBody = {
                        model: config.model,
                        messages: [
                            {
                                role: 'system',
                                content: 'ä½ æ˜¯ä¸€ä½æ¸©å’Œã€æ™ºæ…§çš„å±çµå¯¼å¸ˆï¼Œæ“…é•¿ç”¨åœ£ç»çœŸç†æŒ‡å¯¼ä¿¡å¾’çš„çµä¿®ç”Ÿæ´»ã€‚'
                            },
                            {
                                role: 'user',
                                content: prompt + '\n\n' + content
                            }
                        ],
                        max_tokens: 200,
                        temperature: 0.7
                    };
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    };
                }
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // æ ¹æ®ä¸åŒæ¨¡å‹è§£æå“åº”
                if (model === 'wenxin') {
                    return data.result || 'æ„Ÿè°¢ä½ çš„åˆ†äº«ï¼Œç»§ç»­åœ¨ä¸»é‡Œæˆé•¿ï¼';
                } else if (model === 'qwen') {
                    return data.output.text || 'æ„Ÿè°¢ä½ çš„åˆ†äº«ï¼Œç»§ç»­åœ¨ä¸»é‡Œæˆé•¿ï¼';
                } else {
                    return data.choices[0].message.content || 'æ„Ÿè°¢ä½ çš„åˆ†äº«ï¼Œç»§ç»­åœ¨ä¸»é‡Œæˆé•¿ï¼';
                }
            } catch (error) {
                console.error('AI APIè°ƒç”¨å¤±è´¥:', error);
                return null;
            }
        }

        // è·å–AIå›å¤
        async function getAIResponse(godContent, selfContent) {
            const prompt = `ä½œä¸ºä¸€ä½å±çµå¯¼å¸ˆï¼Œè¯·å¯¹ä»¥ä¸‹çµä¿®å†…å®¹ç»™äºˆæ¸©å’Œã€é¼“åŠ±æ€§çš„æŒ‡å¯¼ï¼š
            
            ä»¥ç¥ä¸ºä¸­å¿ƒçš„å†…å®¹ï¼š${godContent || 'æ— '}
            ä»¥è‡ªæˆ‘ä¸ºä¸­å¿ƒçš„å†…å®¹ï¼š${selfContent || 'æ— '}
            
            è¯·ä»åŸºç£æ•™è§’åº¦ï¼Œæä¾›ç®€çŸ­è€Œæœ‰æ·±åº¦çš„å±çµæŒ‡å¯¼ï¼Œå¸®åŠ©ç”¨æˆ·æ›´å¥½åœ°ç†è§£ç¥çš„å¿ƒæ„å’Œè‡ªæˆ‘æˆé•¿ã€‚`;
            
            const content = `ç”¨æˆ·åˆ†äº«äº†ä»Šå¤©çš„çµä¿®å†…å®¹ï¼Œè¯·ç»™äºˆå±çµæŒ‡å¯¼ã€‚`;
            return await callAI(prompt, content, settings.aiModel, settings.apiKey);
        }

        // ç”Ÿæˆæ€»ç»“
        function generateSummary() {
            const data = devotionData[selectedDate];
            if (!data || !data.messages || data.messages.length === 0) {
                showNotification('è¯¥æ—¥æœŸè¿˜æ²¡æœ‰çµä¿®å†…å®¹');
                return;
            }
            
            // è¿‡æ»¤æ‰æœºå™¨äººè¯„è®º
            const userMessages = data.messages.filter(m => m.type !== 'bot');
            const godMessages = userMessages.filter(m => m.type === 'god');
            const selfMessages = userMessages.filter(m => m.type === 'self');
            
            // ç”Ÿæˆæ€»ç»“è¯„è®º
            let summaryComment = '';
            if (godMessages.length > 0 && selfMessages.length > 0) {
                summaryComment = 'ğŸŒŸ ä¼˜ç§€çš„çµä¿®ï¼ä½ æ—¢å…³æ³¨äº†ç¥çš„å¿ƒæ„ï¼Œä¹Ÿè¯šå®åœ°é¢å¯¹è‡ªå·±ï¼Œè¿™ç§å¹³è¡¡çš„çµä¿®æ–¹å¼å¾ˆæ£’ã€‚';
            } else if (godMessages.length > 0) {
                summaryComment = 'ğŸ™ å¾ˆå¥½ï¼ä½ ä¸“æ³¨äºæ€è€ƒç¥çš„å¿ƒæ„ï¼Œå»ºè®®ä¹Ÿå¯ä»¥å¤šèŠ±æ—¶é—´åæ€è‡ªå·±çš„å±çµçŠ¶å†µã€‚';
            } else if (selfMessages.length > 0) {
                summaryComment = 'ğŸ§ è¯šå®çš„è‡ªæˆ‘åæ€å¾ˆé‡è¦ï¼å»ºè®®åŒæ—¶å¤šæ€è€ƒç¥çš„è¯è¯­å’Œä½œä¸ºï¼Œè®©çµä¿®æ›´åŠ å…¨é¢ã€‚';
            }
            
            // è®¡ç®—å¥–åŠ±
            const coinsEarned = Math.min(userMessages.length, 10);
            
            const summaryHtml = `
                <div class="message bot" data-message-id="summary">
                    <div class="message-header">
                        <div class="avatar bot">å°è€¶</div>
                        <div class="message-info">
                            <div class="sender">å°è€¶æœºå™¨äºº - ä»Šæ—¥æ€»ç»“</div>
                            <div class="message-time">${new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}</div>
                        </div>
                    </div>
                    <div>
                        <table class="summary-table">
                            <tr>
                                <th>ç±»å‹</th>
                                <th>æ•°é‡</th>
                                <th>å†…å®¹æ¦‚è¦</th>
                            </tr>
                            <tr>
                                <td>ğŸ™ ä»¥ç¥ä¸ºä¸­å¿ƒ</td>
                                <td>${godMessages.length}</td>
                                <td>${godMessages.length > 0 ? 'æœ‰è®°å½•ç¥çš„ä½œä¸º' : 'æš‚æ— è®°å½•'}</td>
                            </tr>
                            <tr>
                                <td>ğŸ§ ä»¥è‡ªæˆ‘ä¸ºä¸­å¿ƒ</td>
                                <td>${selfMessages.length}</td>
                                <td>${selfMessages.length > 0 ? 'æœ‰è‡ªæˆ‘åæ€' : 'æš‚æ— è®°å½•'}</td>
                            </tr>
                            <tr>
                                <td>ğŸ’¬ æ€»æ¶ˆæ¯æ•°</td>
                                <td>${userMessages.length}</td>
                                <td>ä½ çš„çµä¿®è®°å½•</td>
                            </tr>
                        </table>
                        
                        <div class="summary-comment">
                            <strong>ğŸ“ æ€»ç»“è¯„è®ºï¼š</strong><br>
                            ${summaryComment}<br><br>
                            <span class="coin-reward">ğŸª™ è·å¾— ${coinsEarned} æšå±çµå¸ï¼</span><br>
                            <small>ç»§ç»­åšæŒçµä¿®ï¼Œè®©å±çµç”Ÿå‘½ä¸æ–­æˆé•¿ï¼</small>
                        </div>
                    </div>
                </div>
            `;
            
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML += summaryHtml;
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // å¥–åŠ±å±çµå¸
            spiritCoins += coinsEarned;
            updateCoinDisplay();
            saveData();
            
            // æ˜¾ç¤ºè·å¾—å¸çš„åŠ¨ç”»
            showCoinAnimation(coinsEarned);
            
            showNotification(`æ€»ç»“ç”Ÿæˆå®Œæˆï¼è·å¾— ${coinsEarned} æšå±çµå¸ï¼`);
        }

        // æ˜¾ç¤ºè·å¾—å¸çš„åŠ¨ç”»
        function showCoinAnimation(coins) {
            for (let i = 0; i < coins; i++) {
                setTimeout(() => {
                    const coin = document.createElement('div');
                    coin.className = 'coin-animation';
                    coin.textContent = 'ğŸª™';
                    coin.style.left = Math.random() * window.innerWidth + 'px';
                    coin.style.top = window.innerHeight / 2 + 'px';
                    document.body.appendChild(coin);
                    
                    setTimeout(() => coin.remove(), 2000);
                }, i * 200);
            }
        }

        // æ›´æ–°å±çµå¸æ˜¾ç¤º
        function updateCoinDisplay() {
            document.getElementById('coinCount').textContent = spiritCoins;
        }

        // è®¾ç½®ç›¸å…³åŠŸèƒ½
        function loadSettings() {
            document.getElementById('nickname').value = settings.nickname;
            document.getElementById('avatarUrl').value = settings.avatarUrl;
            document.getElementById('bgColor').value = settings.bgColor;
            document.getElementById('aiModel').value = settings.aiModel || '';
            document.getElementById('apiKey').value = settings.apiKey;
            document.getElementById('enableBot').checked = settings.enableBot;
            
            // æ›´æ–°æ¨¡å‹ä¿¡æ¯
            updateModelInfo();
            
            // åº”ç”¨èƒŒæ™¯é¢œè‰²
            document.body.style.background = `linear-gradient(135deg, ${settings.bgColor} 0%, ${settings.bgColor}dd 100%)`;
        }

        function saveSettings() {
            settings.nickname = document.getElementById('nickname').value || 'å¼Ÿå…„/å§å¦¹';
            settings.avatarUrl = document.getElementById('avatarUrl').value;
            settings.bgColor = document.getElementById('bgColor').value;
            settings.aiModel = document.getElementById('aiModel').value;
            settings.apiKey = document.getElementById('apiKey').value;
            settings.enableBot = document.getElementById('enableBot').checked;
            
            localStorage.setItem('settings', JSON.stringify(settings));
            loadSettings();
            closeSettings();
            showNotification('è®¾ç½®å·²ä¿å­˜ï¼');
        }

        // ä¿å­˜æ•°æ®
        function saveData() {
            localStorage.setItem('devotionData', JSON.stringify(devotionData));
            localStorage.setItem('spiritCoins', spiritCoins.toString());
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #667eea;
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
